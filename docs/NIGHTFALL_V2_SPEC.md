# Nightfall V2 工程化设计规格书

> 本文档为 Nightfall V2 的完整工程化设计规格书。设计目标是将体验闭环细化为可直接实施的技术方案，并确保与现有架构兼容。

## 一、文档概述

### 1.1 设计原则

| 原则 | 说明 |
| --- | --- |
| 渐进增强 | 在现有稳定架构上迭代，不破坏已有功能 |
| 数据驱动 | 所有新功能都基于真实数据，拒绝“幻觉” |
| 体验闭环 | 每个功能都有明确的入口、过程、出口 |
| 视觉一致 | 保持深夜氛围的视觉语言统一性 |

### 1.2 核心体验循环

```
┌─────────────────────────────────────────────────────────────┐
│                    Nightfall 体验循环                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│   ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌───────┐ │
│   │  激发   │ ──▶ │  探索   │ ──▶ │  抵达   │ ──▶ │ 沉淀  │ │
│   │Discover │     │ Tonight │     │ Ending  │     │Pocket │ │
│   └────┬────┘     └────┬────┘     └────┬────┘     └───┬───┘ │
│        │               │               │              │     │
│        ▼               ▼               ▼              ▼     │
│   ┌─────────┐     ┌─────────┐     ┌─────────┐     ┌───────┐ │
│   │场景卡片 │     │候选列表 │     │结局票根 │     │归档   │ │
│   │一键启动 │     │真实地点 │     │行动建议 │     │分享   │ │
│   └─────────┘     └─────────┘     └─────────┘     └───────┘ │
│                                                             │
│   ┌───────────────────────────────────────────────────────┐ │
│   │                    辅助体验层                          │ │
│   │  ┌─────────┐                          ┌─────────┐     │ │
│   │  │   Sky   │  城市呼吸・匿名共在感     │  Veil   │     │ │
│   │  │ 氛围页  │◀─────────────────────────▶│ 幕布页  │     │ │
│   │  └─────────┘   瞬间共享・视觉窗口      └─────────┘     │ │
│   └───────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 二、模块优化方案

### 2.1 发现页 (Discover) 优化

#### 2.1.1 当前状态
- 完成度: 60%
- 问题: 场景卡片无图片，点击后仅跳转，无预设需求填充

#### 2.1.2 优化目标
将“发现”页升级为意图激发器，通过精美的场景卡片降低用户使用门槛。

#### 2.1.3 数据模型修改
文件: `runtime/skills/registry.ts`

```ts
interface SceneCard {
  id: string;
  title: string;
  subtitle: string;
  preset_query: string;
  skill_id: string;
  image_ref: string;
  gradient: string;
  icon: string;
  tags: string[];
}
```

#### 2.1.4 前端组件修改
文件: `a2ui/programs.ts`、`a2ui/renderer.tsx`

#### 2.1.5 后端 Action 处理
文件: `runtime/nightfallEngine.ts`

#### 2.1.6 视觉转场效果
文件: `index.css`

### 2.2 今晚页 (Tonight) 优化

#### 2.2.1 当前状态
- 完成度: 85%
- 问题: 图片与地点无直接关联，使用 Unsplash 氛围图

#### 2.2.2 优化目标
实现真实地点图片获取，建立多级图片策略。

#### 2.2.3 图片获取策略

```
Level 1: 高德实景图
Level 2: 搜索引擎图片（可选）
Level 3: Unsplash 氛围图
Level 4: 默认占位图
```

### 2.3 氛围页 (Sky) 优化

#### 2.3.1 当前状态
- 完成度: 20%
- 问题: 仅有静态 UI 骨架，无真实数据和可视化

#### 2.3.2 优化目标
将“氛围”页打造为城市情绪气象台，展示城市网格的宏观“呼吸”。

### 2.4 口袋页 (Pocket) 优化

#### 2.4.1 当前状态
- 完成度: 30%
- 问题: 仅有基础列表，无归档和分享功能

#### 2.4.2 优化目标
将“口袋”页升级为记忆策展馆，支持归档和分享。

### 2.5 幕布页 (Veil) 优化

#### 2.5.1 当前状态
- 完成度: 15%
- 问题: 仅有静态拼贴效果，无用户交互

#### 2.5.2 优化目标
将“幕布”页打造为城市瞬间共享屏保，支持用户上传和浏览。

## 三、API 端点规划

| 端点 | 方法 | 描述 | 优先级 |
| --- | --- | --- | --- |
| `/api/scenes` | GET | 获取发现页场景卡片列表 | P0 |
| `/api/atmosphere` | GET | 获取城市氛围数据 | P1 |
| `/api/tickets` | GET | 获取用户票根列表 | P0 |
| `/api/tickets/:id` | PATCH | 更新票根（备注、收藏） | P1 |
| `/api/archives` | POST | 生成归档报告 | P1 |
| `/api/archives/:id/share` | POST | 生成分享链接 | P2 |
| `/api/moments` | GET | 获取瞬间流 | P2 |
| `/api/moments` | POST | 上传瞬间 | P2 |
| `/api/moments/:id/like` | POST | 点赞瞬间 | P2 |
| `/api/places/:id/details` | GET | 获取地点详情（含图片） | P0 |

## 四、数据库 Schema 变更

### 4.1 新增表
见 SQLite 表结构：`scenes` / `tickets` / `archives` / `moments`

## 五、实施路线图

```
Phase 1: 核心体验优化
Phase 2: 记忆功能
Phase 3: 氛围体验
Phase 4: 社区功能
```

## 六、技术依赖

新增依赖包：
`@upstash/redis`、`sharp`、`blurhash`、`qrcode`

## 七、测试清单

- Discover 场景卡片正确显示图片
- 点击场景卡片跳转到 Tonight 并填充查询
- 候选卡片显示真实地点图片（高德优先）
- 票根正确保存到口袋页
- 归档报告正确生成
- 分享链接可访问
- 氛围页显示城市脉搏
- 瞬间上传与展示正常

